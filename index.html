<html>
<head>
    <title>Dashboard Data Kependudukan</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px; /* Space between items when wrapped */
        }

        .filter-controls > div {
            flex: 1; /* Distribute available space */
            min-width: 200px; /* Minimum width to prevent collapse */
        }

        .filter-controls label {
            margin-right: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard-card {
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card h2 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        table.dataTable {
            width: 100% !important;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-controls label {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Dashboard Data Kependudukan</h1>

    <div class="filter-controls">
        <div>
            <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
            <select id="kabupatenSelect" class="form-select">
                <option value="all">Semua</option>
            </select>
        </div>
        <div>
            <label for="kecamatanSelect">Pilih Kecamatan:</label>
            <select id="kecamatanSelect" class="form-select">
                <option value="all">Semua</option>
            </select>
        </div>
        <div>
            <label for="desaSelect">Pilih Desa/Kelurahan:</label>
            <select id="desaSelect" class="form-select">
                <option value="all">Semua</option>
            </select>
        </div>
        <div>
            <label for="chartTypeSelect">Pilih Jenis Grafik:</label>
            <select id="chartTypeSelect" class="form-select">
                <option value="bar">Bar</option>
                <option value="pie">Pie</option>
                <option value="line">Line</option>
            </select>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h2>Data Penduduk</h2>
            <table id="datapendudukTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Agama</h2>
            <div class="chart-container">
                <canvas id="dataagamaChart"></canvas>
            </div>
            <table id="dataagamaTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Jenis Kelamin</h2>
            <div class="chart-container">
                <canvas id="datajeniskelaminChart"></canvas>
            </div>
            <table id="datajeniskelaminTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Status Kawin</h2>
            <div class="chart-container">
                <canvas id="datastatuskawinChart"></canvas>
            </div>
            <table id="datastatuskawinTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Umur</h2>
            <div class="chart-container">
                <canvas id="dataumurChart"></canvas>
            </div>
            <table id="dataumurTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Usia Pendidikan</h2>
            <div class="chart-container">
                <canvas id="datausiadidikChart"></canvas>
            </div>
            <table id="datausiadidikTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Pendidikan</h2>
            <div class="chart-container">
                <canvas id="datapendidikanChart"></canvas>
            </div>
            <table id="datapendidikanTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Golongan Darah</h2>
            <div class="chart-container">
                <canvas id="datagolongandarahChart"></canvas>
            </div>
            <table id="datagolongandarahTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>

        <div class="dashboard-card">
            <h2>Data Pekerjaan</h2>
            <div class="chart-container">
                <canvas id="datapekerjaanChart"></canvas>
            </div>
            <table id="datapekerjaanTable" class="table table-striped table-bordered" style="width:100%"></table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    const csvURL = 'https://raw.githubusercontent.com/firmanh3200/adminduk32/main/gis-dukcapil.csv';

    async function fetchData() {
        try {
            const response = await fetch(csvURL);
            const text = await response.text();

            Papa.parse(text, {
                header: true,
                dynamicTyping: true,
                complete: function (results) {
                    processData(results.data);
                },
                error: function (error) {
                    console.error('Error parsing CSV:', error);
                    document.body.innerText = 'Gagal memproses data CSV.';
                }
            });

        } catch (error) {
            console.error('Error fetching CSV:', error);
            document.body.innerText = 'Gagal memuat data. Periksa koneksi internet dan URL.';
        }
    }

    let allData;
    let currentChartType = 'bar';

    function processData(df) {
        allData = df;

        // 1. Pilihan Kabupaten
        const pilihankab = [...new Set(df.map(item => item['Kabupaten/Kota']))];

        const kabupatenSelect = document.getElementById('kabupatenSelect');
        pilihankab.forEach(kabupaten => {
            const option = document.createElement('option');
            option.value = kabupaten;
            option.textContent = kabupaten;
            kabupatenSelect.appendChild(option);
        });

        // Event listener untuk perubahan Kabupaten
        kabupatenSelect.addEventListener('change', function () {
            const selectedKabupaten = this.value;
            populateKecamatan(selectedKabupaten); // Isi dropdown Kecamatan
            populateDesa('all', selectedKabupaten);
            displayData(selectedKabupaten, 'all', 'all'); // Tampilkan data
        });

        // Event listener untuk perubahan Kecamatan
        const kecamatanSelect = document.getElementById('kecamatanSelect');
        kecamatanSelect.addEventListener('change', function () {
            const selectedKecamatan = this.value;
            const selectedKabupaten = kabupatenSelect.value;
            populateDesa(selectedKecamatan, selectedKabupaten)
            displayData(selectedKabupaten, selectedKecamatan, 'all'); // Tampilkan data
        });

        // Event listener untuk perubahan Desa
        const desaSelect = document.getElementById('desaSelect');
        desaSelect.addEventListener('change', function () {
            const selectedDesa = this.value;
            const selectedKecamatan = kecamatanSelect.value;
            const selectedKabupaten = kabupatenSelect.value;
            displayData(selectedKabupaten, selectedKecamatan, selectedDesa); // Tampilkan data
        });


        // Event listener untuk perubahan jenis grafik
        const chartTypeSelect = document.getElementById('chartTypeSelect');
        chartTypeSelect.addEventListener('change', function () {
            currentChartType = this.value;
            const selectedKabupaten = kabupatenSelect.value;
            const selectedKecamatan = kecamatanSelect.value;
            const selectedDesa = desaSelect.value;
            displayData(selectedKabupaten, selectedKecamatan, selectedDesa);
        });

        populateKecamatan('all'); // Inisialisasi dropdown Kecamatan
        populateDesa('all', 'all');
        displayData('all', 'all', 'all'); // Inisialisasi dengan semua data
    }

    // Fungsi untuk mengisi dropdown Kecamatan
    function populateKecamatan(selectedKabupaten) {
        const kecamatanSelect = document.getElementById('kecamatanSelect');
        kecamatanSelect.innerHTML = '<option value="all">Semua</option>'; // Reset dropdown

        let kecamatanOptions = [];
        if (selectedKabupaten === 'all') {
            kecamatanOptions = [...new Set(allData.map(item => item['Kecamatan']))];
        } else {
            kecamatanOptions = [...new Set(allData.filter(item => item['Kabupaten/Kota'] === selectedKabupaten).map(item => item['Kecamatan']))];
        }

        kecamatanOptions.forEach(kecamatan => {
            const option = document.createElement('option');
            option.value = kecamatan;
            option.textContent = kecamatan;
            kecamatanSelect.appendChild(option);
        });
    }

    // Fungsi untuk mengisi dropdown Desa/Kelurahan
    function populateDesa(selectedKecamatan, selectedKabupaten) {
        const desaSelect = document.getElementById('desaSelect');
        desaSelect.innerHTML = '<option value="all">Semua</option>'; // Reset dropdown

        let desaOptions = [];

        if (selectedKabupaten === 'all' && selectedKecamatan === 'all') {
            desaOptions = [...new Set(allData.map(item => item['Kelurahan/Desa']))]
        } else if (selectedKabupaten !== 'all' && selectedKecamatan === 'all') {
            desaOptions = [...new Set(allData.filter(item => item['Kabupaten/Kota'] === selectedKabupaten).map(item => item['Kelurahan/Desa']))]
        } else if (selectedKabupaten !== 'all' && selectedKecamatan !== 'all') {
            desaOptions = [...new Set(allData.filter(item => item['Kabupaten/Kota'] === selectedKabupaten && item['Kecamatan'] === selectedKecamatan).map(item => item['Kelurahan/Desa']))];
        } else if (selectedKabupaten === 'all' && selectedKecamatan !== 'all') {
            desaOptions = [...new Set(allData.filter(item => item['Kecamatan'] === selectedKecamatan).map(item => item['Kelurahan/Desa']))];
        }

        desaOptions.forEach(desa => {
            const option = document.createElement('option');
            option.value = desa;
            option.textContent = desa;
            desaSelect.appendChild(option);
        });
    }

    function displayData(selectedKabupaten, selectedKecamatan, selectedDesa) {
        let filteredData = allData;

        if (selectedKabupaten !== 'all') {
            filteredData = filteredData.filter(item => item['Kabupaten/Kota'] === selectedKabupaten);
        }

        if (selectedKecamatan !== 'all') {
            filteredData = filteredData.filter(item => item['Kecamatan'] === selectedKecamatan);
        }

        if (selectedDesa !== 'all') {
            filteredData = filteredData.filter(item => item['Kelurahan/Desa'] === selectedDesa);
        }

        const initDataTable = (tableId, data, columns) => {
            console.log(`Initializing DataTables for ${tableId} with data:`, data);

            $(`#${tableId}`).DataTable({
                data: data,
                columns: columns.map(col => ({
                    data: col.data,
                    title: col.title,
                    defaultContent: ''
                })),
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print', 'colVis'
                ],
                "paging": true,
                "ordering": true,
                "info": true,
                "searching": true,
                "destroy": true,
                language: {
                    zeroRecords: "Tidak ada data yang tersedia."
                }

            });
        };

        const destroyChart = (chartId) => {
            const chart = Chart.getChart(chartId);
            if (chart) {
                chart.destroy();
            }
        }

        // 2. Data Penduduk
        const datapenduduk = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            'Jumlah Penduduk': item['Jumlah Penduduk'] || 0,
            'Jumlah Kepala Keluarga': item['Jumlah Kepala Keluarga'] || 0
        }));

        initDataTable('datapendudukTable', datapenduduk, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'},
            {data: 'Jumlah Kepala Keluarga', title: 'Jumlah Kepala Keluarga'}
        ]);


        // 3. Data Agama
        const dataagama = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            Islam: item['Islam'] || 0,
            Kristen: item['Kristen'] || 0,
            Katholik: item['Katholik'] || 0,
            Hindu: item['Hindu'] || 0,
            Buddha: item['Buddha'] || 0,
            Konghuchu: item['Konghuchu'] || 0,
            'Kepercayaan terhadap Tuhan YME': item['Kepercayaan terhadap Tuhan YME'] || 0
        }));
        const dataagama2 = melt(dataagama, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['Islam', 'Kristen', 'Katholik', 'Hindu', 'Buddha', 'Konghuchu', 'Kepercayaan terhadap Tuhan YME'], 'Agama', 'Jumlah Penduduk');

        initDataTable('dataagamaTable', dataagama2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Agama', title: 'Agama'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('dataagamaChart');
        createChart('dataagamaChart', dataagama2, 'Agama', 'Jumlah Penduduk', currentChartType);

        // 4. Data Jenis Kelamin
        const datajeniskelamin = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            'Laki-laki': item['Laki-laki'] || 0,
            Perempuan: item['Perempuan'] || 0
        }));
        const datajeniskelamin2 = melt(datajeniskelamin, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['Laki-laki', 'Perempuan'], 'Jenis Kelamin', 'Jumlah Penduduk');

        initDataTable('datajeniskelaminTable', datajeniskelamin2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Jenis Kelamin', title: 'Jenis Kelamin'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('datajeniskelaminChart');
        createChart('datajeniskelaminChart', datajeniskelamin2, 'Jenis Kelamin', 'Jumlah Penduduk', currentChartType);

        // 5. Data Status Kawin
        const datastatuskawin = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            'Belum Kawin': item['Belum Kawin'] || 0,
            Kawin: item['Kawin'] || 0,
            'Cerai Hidup': item['Cerai Hidup'] || 0,
            'Cerai Mati': item['Cerai Mati'] || 0
        }));
        const datastatuskawin2 = melt(datastatuskawin, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['Belum Kawin', 'Kawin', 'Cerai Hidup', 'Cerai Mati'], 'Status Kawin', 'Jumlah Penduduk');

        initDataTable('datastatuskawinTable', datastatuskawin2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Status Kawin', title: 'Status Kawin'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('datastatuskawinChart');
        createChart('datastatuskawinChart', datastatuskawin2, 'Status Kawin', 'Jumlah Penduduk', currentChartType);

        // 6. Data Umur
        const dataumur = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            '00 - 04': item['00 - 04'] || 0,
            '05 - 09': item['05 - 09'] || 0,
            '10 - 14': item['10 - 14'] || 0,
            '15 - 19': item['15 - 19'] || 0,
            '20 - 24': item['20 - 24'] || 0,
            '25 - 29': item['25 - 29'] || 0,
            '30 - 34': item['30 - 34'] || 0,
            '35 - 39': item['35 - 39'] || 0,
            '40 - 44': item['40 - 44'] || 0,
            '45 - 49': item['45 - 49'] || 0,
            '50 - 54': item['50 - 54'] || 0,
            '55 - 59': item['55 - 59'] || 0,
            '60 - 64': item['60 - 64'] || 0,
            '65 - 69': item['65 - 69'] || 0,
            '70 - 74': item['70 - 74'] || 0,
            '75+': item['75+'] || 0
        }));
        const dataumur2 = melt(dataumur, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['00 - 04', '05 - 09', '10 - 14', '15 - 19', '20 - 24', '25 - 29', '30 - 34', '35 - 39', '40 - 44', '45 - 49', '50 - 54', '55 - 59', '60 - 64', '65 - 69', '70 - 74', '75+'], 'Kelompok Umur', 'Jumlah Penduduk');

        initDataTable('dataumurTable', dataumur2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Kelompok Umur', title: 'Kelompok Umur'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);
        destroyChart('dataumurChart');
        createChart('dataumurChart', dataumur2, 'Kelompok Umur', 'Jumlah Penduduk', currentChartType);

        // 7. Data Usia Pendidikan
        const datausiadidik = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            '03 - 04': item['03 - 04'] || 0,
            '05': item['05'] || 0,
            '06 - 11': item['06 - 11'] || 0,
            '12 - 14': item['12 - 14'] || 0,
            '15 - 17': item['15 - 17'] || 0,
            '18 - 22': item['18 - 22'] || 0
        }));
        const datausiadidik2 = melt(datausiadidik, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['03 - 04', '05', '06 - 11', '12 - 14', '15 - 17', '18 - 22'], 'Usia Pendidikan', 'Jumlah Penduduk');

        initDataTable('datausiadidikTable', datausiadidik2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Usia Pendidikan', title: 'Usia Pendidikan'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('datausiadidikChart');
        createChart('datausiadidikChart', datausiadidik2, 'Usia Pendidikan', 'Jumlah Penduduk', currentChartType);

        // 8. Data Pendidikan
        const datapendidikan = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            'Tidak/Belum Sekolah': item['Tidak/Belum Sekolah'] || 0,
            'Belum Tamat SD': item['Belum Tamat SD'] || 0,
            'Tamat SD': item['Tamat SD'] || 0,
            'SLTP': item['SLTP'] || 0,
            'SLTA': item['SLTA'] || 0,
            'D1 dan D2': item['D1 dan D2'] || 0,
            'D3': item['D3'] || 0,
            'S1': item['S1'] || 0,
            'S2': item['S2'] || 0,
            'S3': item['S3'] || 0
        }));
        const datapendidikan2 = melt(datapendidikan, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['Tidak/Belum Sekolah', 'Belum Tamat SD', 'Tamat SD', 'SLTP', 'SLTA', 'D1 dan D2', 'D3', 'S1', 'S2', 'S3'], 'Pendidikan', 'Jumlah Penduduk');

        initDataTable('datapendidikanTable', datapendidikan2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Pendidikan', title: 'Pendidikan'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('datapendidikanChart');
        createChart('datapendidikanChart', datapendidikan2, 'Pendidikan', 'Jumlah Penduduk', currentChartType);

        // 9. Data Golongan Darah
        const datagolongandarah = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            O: item['O'] || 0,
            'B-': item['B-'] || 0,
            'B+': item['B+'] || 0,
            'O+': item['O+'] || 0,
            'AB-': item['AB-'] || 0,
            A: item['A'] || 0,
            'Tidak Diketahui': item['Tidak Diketahui'] || 0,
            'AB+': item['AB+'] || 0,
            'A+': item['A+'] || 0,
            'A-': item['A-'] || 0,
            'O-': item['O-'] || 0,
            B: item['B'] || 0,
            AB: item['AB'] || 0
        }));
        const datagolongandarah2 = melt(datagolongandarah, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['O', 'B-', 'B+', 'O+', 'AB-', 'A', 'Tidak Diketahui', 'AB+', 'A+', 'A-', 'O-', 'B', 'AB'], 'Golongan Darah', 'Jumlah Penduduk');

        initDataTable('datagolongandarahTable', datagolongandarah2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Golongan Darah', title: 'Golongan Darah'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('datagolongandarahChart');
        createChart('datagolongandarahChart', datagolongandarah2, 'Golongan Darah', 'Jumlah Penduduk', currentChartType);

        // 10. Data Pekerjaan
        const datapekerjaan = filteredData.map(item => ({
            Provinsi: String(item['Provinsi'] || ''),
            'Kabupaten/Kota': String(item['Kabupaten/Kota'] || ''),
            Kecamatan: String(item['Kecamatan'] || ''),
            'Kelurahan/Desa': String(item['Kelurahan/Desa'] || ''),
            'Belum/Tidak Bekerja': item['Belum/Tidak Bekerja'] || 0,
            Pensiunan: item['Pensiunan'] || 0,
            'Mengurus Rumah Tannga': item['Mengurus Rumah Tannga'] || 0,
            Perdagangan: item['Perdagangan'] || 0,
            Perawat: item['Perawat'] || 0,
            Nelayan: item['Nelayan'] || 0,
            'Pelajar dan Mahasiswa': item['Pelajar dan Mahasiswa'] || 0,
            Guru: item['Guru'] || 0,
            Wiraswasta: item['Wiraswasta'] || 0,
            Pengacara: item['Pengacara'] || 0,
            'Pekerjaan Lainnya': item['Pekerjaan Lainnya'] || 0
        }));
        const datapekerjaan2 = melt(datapekerjaan, ['Provinsi', 'Kabupaten/Kota', 'Kecamatan', 'Kelurahan/Desa'], ['Belum/Tidak Bekerja', 'Pensiunan', 'Mengurus Rumah Tannga', 'Perdagangan', 'Perawat', 'Nelayan', 'Pelajar dan Mahasiswa', 'Guru', 'Wiraswasta', 'Pengacara', 'Pekerjaan Lainnya'], 'Pekerjaan', 'Jumlah Penduduk');

        initDataTable('datapekerjaanTable', datapekerjaan2, [
            {data: 'Provinsi', title: 'Provinsi'},
            {data: 'Kabupaten/Kota', title: 'Kabupaten/Kota'},
            {data: 'Kecamatan', title: 'Kecamatan'},
            {data: 'Kelurahan/Desa', title: 'Kelurahan/Desa'},
            {data: 'Pekerjaan', title: 'Pekerjaan'},
            {data: 'Jumlah Penduduk', title: 'Jumlah Penduduk'}
        ]);

        destroyChart('datapekerjaanChart');
        createChart('datapekerjaanChart', datapekerjaan2, 'Pekerjaan', 'Jumlah Penduduk', currentChartType);
    }

    // Fungsi melt (pivot_longer)
    function melt(data, idVars, valueVars, varName, valueName) {
        const result = [];
        data.forEach(item => {
            valueVars.forEach(variable => {
                const newItem = {};
                idVars.forEach(idVar => {
                    newItem[idVar] = String(item[idVar] || '');
                });
                newItem[varName] = String(variable || '');
                newItem[valueName] = item[variable] || 0;
                result.push(newItem);
            });
        });
        return result;
    }

    // Fungsi untuk membuat chart
    function createChart(canvasId, data, labelField, dataField, type = 'bar') {
        const canvas = document.getElementById(canvasId).getContext('2d');

        const labels = data.map(item => String(item[labelField] || ''));
        const values = data.map(item => item[dataField] || 0);

        new Chart(canvas, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: dataField,
                    data: values,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(0, 123, 255, 0.2)',
                        'rgba(173, 216, 230, 0.2)',
                        'rgba(255, 182, 193, 0.2)',
                        'rgba(221, 160, 221, 0.2)',
                        'rgba(144, 238, 144, 0.2)',
                        'rgba(240, 230, 140, 0.2)'

                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(0, 123, 255, 1)',
                        'rgba(173, 216, 230, 1)',
                        'rgba(255, 182, 193, 1)',
                        'rgba(221, 160, 221, 1)',
                        'rgba(144, 238, 144, 1)',
                        'rgba(240, 230, 140, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: labelField + ' vs. ' + dataField
                    }
                }
            }
        });
    }

    fetchData();
</script>
</body>
</html>
